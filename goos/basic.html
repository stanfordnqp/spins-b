<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Extending SPINS" href="extending.html" /><link rel="prev" title="Solvers" href="installation.html" />

    <!-- Generated with Sphinx 5.3.0 and Furo 2022.12.07 -->
        <title>Core Concepts - spins 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=91d0f0d1c444bdcb17a68e833c7a53903343c195" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">spins 0.2.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">spins 0.2.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../invdes/index.html">Invdes</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../invdes/examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../invdes/examples_grating_coupler.html">Example: Grating Coupler Optimization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Goos</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html">Solvers</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Core Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending.html">Extending SPINS</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html">Advanced Topics</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="core-concepts">
<h1>Core Concepts<a class="headerlink" href="#core-concepts" title="Permalink to this heading">#</a></h1>
<p>Here we describe the core concepts behind Goos.</p>
<section id="optimization-plan">
<h2>Optimization Plan<a class="headerlink" href="#optimization-plan" title="Permalink to this heading">#</a></h2>
<p>The <em>optimization plan</em> is the central object in SPINS. It consists of two
parts: <em>nodes</em> that form the <em>problem graph</em> and <em>actions</em> that use the
problem graph to update the state of the optimization. The problem graph
provides a complete description of the entire problem, from details of the
simulation to the exact objective functions. A sequence of actions define
the optimization strategy. Actions may change values of variables, minimize
a particular objective function, perform a discretization optimization, and so
forth. Actions use the problem graph to compute any quantities, such as the
objective function.</p>
<section id="optimization-plan-example">
<h3>Optimization Plan Example<a class="headerlink" href="#optimization-plan-example" title="Permalink to this heading">#</a></h3>
<p>Consider a simple optimization plan to minimize the function <span class="math notranslate nohighlight">\((x - 1)^2\)</span>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
   <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

   <span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">scipy_minimize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
   <span class="n">plan</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>In this example, <code class="code docutils literal notranslate"><span class="pre">x</span></code> and <code class="code docutils literal notranslate"><span class="pre">obj</span></code> are nodes defined in the problem
graph and <code class="code docutils literal notranslate"><span class="pre">goos.opt.scipy_minimize</span></code> creates an optimization action. Note that
the expressions <code class="code docutils literal notranslate"><span class="pre">(x-1)**2</span></code> implicitly defines several nodes and is a
shorthand for the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following is identical in behavior to `(x - 1)**2`.</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Power</span><span class="p">(</span><span class="n">goos</span><span class="o">.</span><span class="n">Sum</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>In goos, by using the optimization plan with a <code class="code docutils literal notranslate"><span class="pre">with</span></code> statement, nodes and
actions that are defined within the <code class="code docutils literal notranslate"><span class="pre">with</span></code>-block are added automatically to
the enclosing optimization plan. The above example could alternatively have
been written as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plan</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="n">plan</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="n">opt_action</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">ScipyOptimizer</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plan</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span><span class="n">opt_action</span><span class="p">)</span>

<span class="n">plan</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Notice that we do not have to add <code class="code docutils literal notranslate"><span class="pre">x</span></code>, <code class="code docutils literal notranslate"><span class="pre">obj</span></code>, and the implicit sum node
explicitly; <code class="code docutils literal notranslate"><span class="pre">add_node</span></code> will automatically add all the dependencies of a given
node into the optimization plan.</p>
<p>For the rest of this documentation, we will assume that you are using context
managers (<code class="code docutils literal notranslate"><span class="pre">with</span></code>-block) with the optimization plan, but you can always choose
to call the underlying optimization plan function to achieve the same results.</p>
</section>
<section id="executing-plans">
<h3>Executing Plans<a class="headerlink" href="#executing-plans" title="Permalink to this heading">#</a></h3>
<p>When an optimization plan is defined, no code is actually executed. This means
that you can write out your entire optimization methodology and make sure
it is syntactically correct. Additionally, goos has some basic type checks
to make sure you do not accidentally make a mistake in passing arguments to
goos node. That way, you do not run a long-running optimization, only to have it
suddenly fail because of a silly typo.</p>
<p>To actually execute a plan, you call <code class="code docutils literal notranslate"><span class="pre">run</span></code>. All the actions will be executed
up to that point in time. If you add additional actions afterwards, you can
call <code class="code docutils literal notranslate"><span class="pre">run</span></code> again to execute them:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

   <span class="c1"># Add an action to set the variable to 5.</span>
   <span class="c1"># After this call, `x` still is 3.</span>
   <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

   <span class="c1"># After this call, `x` will be 5.</span>
   <span class="n">plan</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

   <span class="c1"># Add another action.</span>
   <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
   <span class="c1"># After this call, `x` will be 6.</span>
   <span class="n">plan</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="retrieving-values">
<h3>Retrieving Values<a class="headerlink" href="#retrieving-values" title="Permalink to this heading">#</a></h3>
<p>You can retrieve the value of any node by calling <code class="code docutils literal notranslate"><span class="pre">get</span></code> and the gradient of
numerical nodes with respect to any node by calling <code class="code docutils literal notranslate"><span class="pre">get_grad</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span>

  <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># Returns `goos.NumericFlow(array=3)`.</span>
  <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># Returns `goos.NumericFlow(array=17)`.</span>

  <span class="n">y</span><span class="o">.</span><span class="n">get_grad</span><span class="p">([</span><span class="n">x</span><span class="p">])</span>  <span class="c1"># Returns `[goos.NumericFlow.Grad(array_grad=5)]`.</span>
</pre></div>
</div>
<p>Note that the return value of <code class="code docutils literal notranslate"><span class="pre">get</span></code> and <code class="code docutils literal notranslate"><span class="pre">get_grad</span></code> are <em>flows</em>. The reason is
that some nodes do not return numeric values but instead return other types,
such as shapes. For numeric functions and variables, they always return
<code class="code docutils literal notranslate"><span class="pre">goos.NumericFlow</span></code> for the function and <code class="code docutils literal notranslate"><span class="pre">goos.NumericFlow.Grad</span></code> for the
gradient.</p>
<p>Keep in mind that calling <code class="code docutils literal notranslate"><span class="pre">get</span></code> does not execute actions. It evaluates the node
with the current optimization plan state. You can pass <code class="code docutils literal notranslate"><span class="pre">run=True</span></code> to <code class="code docutils literal notranslate"><span class="pre">get</span></code>
in order to call <code class="code docutils literal notranslate"><span class="pre">run</span></code> on the plan before retrieving the value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

  <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># Returns `goos.NumericFlow(array=3)`.</span>

  <span class="c1"># The following is equivalent to the lines:</span>
  <span class="c1">#     plan.run()</span>
  <span class="c1">#     x.get()</span>
  <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Returns `goos.NumericFlow(array=5)`.</span>
</pre></div>
</div>
</section>
<section id="logging-and-checkpoints">
<h3>Logging and Checkpoints<a class="headerlink" href="#logging-and-checkpoints" title="Permalink to this heading">#</a></h3>
<p>Some actions, such as optimizations, will generate logging information and
periodically save the state of the optimization plan. This data will be saved
in the optimization plan save directory, which is set by passing in <code class="code docutils literal notranslate"><span class="pre">save_path</span></code>
when creating an optimization plan:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">(</span><span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;/path/to/myplan&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
   <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
   <span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">scipy_minimize</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">monitor_list</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span>
   <span class="n">plan</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

   <span class="c1"># You should see `/path/to/myplan` contain Pickle files containing the</span>
   <span class="c1"># state of each optimization step. Each file contains information</span>
   <span class="c1"># about `x` as well as the objective function value `obj`.</span>
</pre></div>
</div>
<p>Instead of relying on actions to save the state, you can force <em>checkpoints</em> to
be saved at any time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">(</span><span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;/path/to/myplan&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
   <span class="c1"># The following will write the state to</span>
   <span class="c1"># `/path/to/myplan/mycheckpoint.chkpt`.</span>
   <span class="n">plan</span><span class="o">.</span><span class="n">write_checkpoint</span><span class="p">(</span><span class="s2">&quot;mycheckpoint.chkpt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="saving-and-loading-plans">
<h3>Saving and Loading Plans<a class="headerlink" href="#saving-and-loading-plans" title="Permalink to this heading">#</a></h3>
<p>Optimization plans can be loaded and saved using the <code class="code docutils literal notranslate"><span class="pre">load</span></code> and <code class="code docutils literal notranslate"><span class="pre">save</span></code> commands.
Note that these functions only load and save the problem graph and actions but
do not save any variable state. See <a class="reference internal" href="#logging-and-checkpoints"><span class="std std-ref">Logging and Checkpoints</span></a> for saving
actual state.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">(</span><span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;/path/to/myplan&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
   <span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">scipy_minimize</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">)</span>
   <span class="c1"># The following creates `/path/to/myplan/optplan.json`.</span>
   <span class="n">plan</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">(</span><span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;/path/to/myplan&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
   <span class="c1"># The following loads from `/path/to/myplan/optplan.json`.</span>
   <span class="c1"># You could also explicitly state the save folder:</span>
   <span class="c1"># `plan.load(&quot;/path/to/myplan&quot;)`.</span>
   <span class="n">plan</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
   <span class="c1"># `x.get() == 3`</span>

   <span class="n">plan</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
   <span class="c1"># `x.get() == 1`.</span>
</pre></div>
</div>
</section>
<section id="debugging-plans">
<h3>Debugging Plans<a class="headerlink" href="#debugging-plans" title="Permalink to this heading">#</a></h3>
<p>Because plans are not executed as soon as nodes are declared, you may find it
useful to declare temporary debugging plans to test out the behavior of your
code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>

   <span class="c1"># Some code that involves a lot of computation (e.g. electromagnetic</span>
   <span class="c1"># simulations).</span>
   <span class="o">...</span>

   <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
   <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

   <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

   <span class="c1"># We want to know what the value of `y` would be here but we do not</span>
   <span class="c1"># want to run the plan and trigger the code that involves a lot of</span>
   <span class="c1"># computation. Instead, we create a temporary plan which only includes</span>
   <span class="c1"># `x` and `y`.</span>
   <span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_plan</span><span class="p">:</span>
       <span class="c1"># This new plan does NOT have the `x.set` action so we repeat it.</span>
       <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
       <span class="c1"># This executes the `temp_plan` and not the original `plan`.</span>
       <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Returns 9.</span>

       <span class="c1"># We could continue to test out what `y` equals with different</span>
       <span class="c1"># values of `x`.</span>
       <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
       <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

   <span class="c1"># Here, `temp_plan` is destroyed, along with all of its actions and state.</span>
   <span class="c1"># (`x.get()` returns 3 and `y.get()` returns 9 still).</span>
</pre></div>
</div>
</section>
</section>
<section id="problem-graph">
<h2>Problem Graph<a class="headerlink" href="#problem-graph" title="Permalink to this heading">#</a></h2>
<section id="variable-nodes">
<h3>Variable Nodes<a class="headerlink" href="#variable-nodes" title="Permalink to this heading">#</a></h3>
<p>Variable nodes can be thought of as nodes that hold raw numeric data. Variables
act as sources of data for the rest of the computational graph, and the state
of the optimization plan is fully captured by the state of all the variables.</p>
<p>To create a variable, simply pass in the initial value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">var_scalar</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">var_vector</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vector&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>As the optimization plan is executed, the actions will change the values of
of the variables. However, you can directly set the value of a variable using
the <code class="code docutils literal notranslate"><span class="pre">set</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">var</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># We can also use one variable to set the value of another.</span>
<span class="n">var2</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">var2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
<p>In SPINS, a variable state contains the following:</p>
<ul class="simple">
<li><p>a numeric value, stored as a NumPy array</p></li>
<li><p>upper and lower bounds on each element of array</p></li>
<li><p>its frozen state</p></li>
</ul>
<p>The upper and lower bounds of a variable (i.e. box constraints) are used by
optimizers when performing an optimization. These are treated differently than
generic constraints as there are many optimization algorithms that can handle
these box constraints but not general constraints. Upper and lower bounds
can be set during initialization:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constraint the variable to between 0 and 10.</span>
<span class="n">var</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">lower_bounds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper_bounds</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Each entry can have different bounds. The following constraints</span>
<span class="c1"># the first entry to be between 0 and 1 and the second entry to be between</span>
<span class="c1"># 0 and 2.</span>
<span class="n">var2</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">lower_bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">upper_bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
<p>Variables also have a boolean flag indicating whether they are <em>frozen</em>. Frozen
variables have zero gradient and are not (usually) modified by actions. The
“frozenness” can be changed by calling <code class="code docutils literal notranslate"><span class="pre">freeze</span></code> and <code class="code docutils literal notranslate"><span class="pre">thaw</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>


<span class="n">x</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">scipy_minimize</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">)</span>
<span class="c1"># `x` remains at 3 because it is frozen. `y` is now zero.</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
<span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

<span class="n">x</span><span class="o">.</span><span class="n">thaw</span><span class="p">()</span>
<span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">scipy_minimize</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">)</span>
<span class="c1"># Now both `x` and `y` are zero.</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>
<span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

<span class="n">x</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="c1"># The following will raise an exception during execution!</span>
<span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>Sometimes a variable is meant as a parameter and should never be
optimized over. In these cases, the variable can be declared as a <em>parameter</em>.
Parameters are always frozen but can be set explicitly using <code class="code docutils literal notranslate"><span class="pre">set</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">scipy_minimize</span><span class="p">(</span><span class="n">param</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">)</span>
<span class="c1"># `param` does not change because it is frozen by default.</span>
<span class="k">assert</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
<span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

<span class="c1"># The following does NOT raise an exception because it is initialized as</span>
<span class="c1"># a parameter.</span>
<span class="n">param</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="math-nodes">
<h3>Math Nodes<a class="headerlink" href="#math-nodes" title="Permalink to this heading">#</a></h3>
<p>Math (<code class="code docutils literal notranslate"><span class="pre">goos.Function</span></code>) nodes are nodes that perform mathematical operations,
such as addition, multiplication, and dot products.  They take in numerical
input and produce numerical output (specifically, they take other
<code class="code docutils literal notranslate"><span class="pre">goos.Function</span></code> nodes as input and produce <code class="code docutils literal notranslate"><span class="pre">goos.NumericFlow</span></code> as output).</p>
<p>SPINS has implemented a common subset of useful mathematical functions and
provided operator overloads for the basic operations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="c1"># Element-wise operations.</span>
<span class="n">sum_node</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">prod_node</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
<span class="n">sub_node</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span>
<span class="n">div_node</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>
<span class="c1"># Note that the power must be a constant. It can NOT be a variable.</span>
<span class="n">power_node</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># Vector operations.</span>
<span class="c1"># Computes `||x||`.</span>
<span class="n">norm_node</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">dot_prod_node</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="shape-nodes">
<h3>Shape Nodes<a class="headerlink" href="#shape-nodes" title="Permalink to this heading">#</a></h3>
<p>Shape nodes are those that represent a permittivity distribution and include
objects such as cylinders and boxes. Parametrized permittivity distributions
are also shapes.</p>
<p>Simple shapes, such as cylinders, as straightforward to create:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">box</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Cuboid</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                  <span class="n">extents</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">220</span><span class="p">]),</span>
                  <span class="n">material</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">cyl</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Cylinder</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                    <span class="n">radius</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">50</span><span class="p">]),</span>
                    <span class="n">height</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">220</span><span class="p">]),</span>
                    <span class="n">material</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Notice that you can also compute these quantities dynamically.</span>
<span class="n">start_pos</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">delta_pos</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
  <span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">goos</span><span class="o">.</span><span class="n">Cuboid</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">start_pos</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">delta_pos</span><span class="p">,</span>
                           <span class="n">extents</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span>
                           <span class="n">material</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>SPINS also defines certain shapes useful for inverse design. For example,
the pixelated continuous shape represents a shape composed of voxels that can
take on permittivities continuously between that of two materials. Often there
are special functions defined to help create these shapes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The initializer is a function that accepts a single parameter `shape` and</span>
<span class="c1"># must return an array of numbers with shape `shape`.</span>
<span class="k">def</span> <span class="nf">initializer</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="c1"># `vae` is a `goos.Variable` node that controls the value of the shape node</span>
<span class="c1"># `design`.</span>
<span class="n">var</span><span class="p">,</span> <span class="n">design</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">pixelated_cont_shape</span><span class="p">(</span>
    <span class="n">initializer</span><span class="o">=</span><span class="n">initializer</span><span class="p">,</span>
    <span class="n">pos</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">Constant</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
    <span class="n">extents</span><span class="o">=</span><span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">220</span><span class="p">],</span>
    <span class="n">pixel_size</span><span class="o">=</span><span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">220</span><span class="p">],</span>  <span class="c1"># Each voxel is 40 x 40 x 220.</span>
    <span class="c1"># The pixels can have refractive indices between 1 and 2.</span>
    <span class="n">material</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">material2</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="simulation-nodes">
<h3>Simulation Nodes<a class="headerlink" href="#simulation-nodes" title="Permalink to this heading">#</a></h3>
<p>Simulations are nodes themselves. Simulation nodes take as input the
permittivity distribution and produces as output the electric fields and other
related quantities, such as modal overlaps. Note that each simulation node
has a different set of capabilities, so you should consult the documentation
for each simulation node. Typically, setting up the simulation involves the
following components:</p>
<ul class="simple">
<li><p>Specification of the simulation space, i.e. simultaions extents, meshing,
boundary conditions, etc.</p></li>
<li><p>Permittivity distribution to simulate</p></li>
<li><p>Source specification</p></li>
<li><p>Output specification, e.g. electric fields, modal overlaps, etc.</p></li>
<li><p>Additional simulation-specific parameters.</p></li>
</ul>
<p>As an example, below is how to setup a FDFD simulation using the built-in
Maxwell solver:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the desired simulator.</span>
<span class="kn">from</span> <span class="nn">spins.goos.simulator</span> <span class="kn">import</span> <span class="n">maxwell</span>

<span class="n">waveguide</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Cuboid</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">var</span><span class="p">,</span> <span class="n">design</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">pixelated_cont_shape</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># Group the waveguide and design together into one permittivity</span>
<span class="c1"># distribution.</span>
<span class="n">eps</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">GroupShape</span><span class="p">([</span><span class="n">waveguide</span><span class="p">,</span> <span class="n">design</span><span class="p">])</span>

<span class="n">sim</span> <span class="o">=</span> <span class="n">maxwell</span><span class="o">.</span><span class="n">fdfd_simulation</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sim&quot;</span><span class="p">,</span>
    <span class="n">wavelength</span><span class="o">=</span><span class="mi">1550</span><span class="p">,</span>  <span class="c1"># Wavelength of the simulation.</span>
    <span class="n">simulation_space</span><span class="o">=</span><span class="n">maxwell</span><span class="o">.</span><span class="n">SimulationSpace</span><span class="p">(</span>
        <span class="n">mesh</span><span class="o">=</span><span class="n">maxwell</span><span class="o">.</span><span class="n">UniformMesh</span><span class="p">(</span><span class="n">dx</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
        <span class="n">sim_region</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">Box3d</span><span class="p">(</span>
            <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">extents</span><span class="o">=</span><span class="p">[</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="n">sim_z_extent</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">pml_thickness</span><span class="o">=</span><span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
    <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span>
    <span class="n">sources</span><span class="o">=</span><span class="p">[</span>
        <span class="c1"># Add a single waveguide mode source.</span>
        <span class="n">maxwell</span><span class="o">.</span><span class="n">WaveguideModeSource</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                    <span class="n">extents</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
                                    <span class="n">normal</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                    <span class="n">mode_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">background</span><span class="o">=</span><span class="n">goos</span><span class="o">.</span><span class="n">material</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
    <span class="n">outputs</span><span class="o">=</span><span class="p">[</span>
        <span class="n">maxwell</span><span class="o">.</span><span class="n">Epsilon</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;eps&quot;</span><span class="p">),</span>
        <span class="n">maxwell</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;field&quot;</span><span class="p">),</span>
        <span class="n">maxwell</span><span class="o">.</span><span class="n">WaveguideModeOverlap</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span>
                                     <span class="n">center</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1400</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                     <span class="n">extents</span><span class="o">=</span><span class="p">[</span><span class="mi">2500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
                                     <span class="n">normal</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                     <span class="n">mode_num</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">power</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;local_direct&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># We can now extract the simulation outputs either as `sim[0]`, `sim[1] `,</span>
<span class="c1"># etc. or as `sim[&quot;eps&quot;]`, `sim[&quot;field&quot;]`, etc. because we added a name</span>
<span class="c1"># for each output.</span>

<span class="c1"># Define an objective function based on the modal overlap integral.</span>
<span class="n">obj</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">goos</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="s2">&quot;overlap&quot;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</section>
<section id="flows">
<h3>Flows<a class="headerlink" href="#flows" title="Permalink to this heading">#</a></h3>
<p>Flows are data objects that are generated by <em>nodes</em>. These include general
NumPy arrays and shape objects that represent permittivity distributions.
Flows are essentially a generalization of tensors used in machine learning.
Unless you are implementing your own nodes, you will mainly only encounter nodes
when evaluating the result of a node (i.e. call <code class="code docutils literal notranslate"><span class="pre">node.get</span></code>).</p>
<section id="numericflow">
<h4>NumericFlow<a class="headerlink" href="#numericflow" title="Permalink to this heading">#</a></h4>
<p>Numeric flows have a single field called <code class="code docutils literal notranslate"><span class="pre">array</span></code>, which contains a
multi-dimensional NumPy array. There is no instrinsic meaning behind the values
in the array. Math nodes (those that inherit from <code class="code docutils literal notranslate"><span class="pre">goos.Function</span></code>) return
numeric flows.</p>
<p>Numeric flows have some basic overloads for <code class="code docutils literal notranslate"><span class="pre">==</span></code> so that you can quickly compare
numeric flows and the underlying array.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<span class="c1"># Flows have an `array` property.</span>
<span class="k">assert</span> <span class="n">flow</span><span class="o">.</span><span class="n">array</span> <span class="o">==</span> <span class="mi">4</span>
<span class="c1"># But for simple cases, you can drop the `array`.</span>
<span class="k">assert</span> <span class="n">flow</span> <span class="o">==</span> <span class="mi">4</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="actions">
<h2>Actions<a class="headerlink" href="#actions" title="Permalink to this heading">#</a></h2>
<p>Where as nodes setup the problem grpah and determine how values are computed,
actions actually perform the computation and are able to modify variable values.
In fact, only actions are allowed to modify the state of any variables.
The most common action is to run an optimization, but a single optimization plan
may contain many actions, including setting/changing variable values and running
a discretization procedure.</p>
<p>You can distinguish an action from a node in that actions always inherit from
<code class="code docutils literal notranslate"><span class="pre">goos.Action</span></code>, though it should be clear from context whether something
is an action.</p>
<p>In the code snippet below, the calls to <code class="code docutils literal notranslate"><span class="pre">goos.opt.scipy_minimize</span></code> and
<code class="code docutils literal notranslate"><span class="pre">goos.Variable.set</span></code> generate actions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">target</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">parameter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

  <span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">scipy_minimize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

  <span class="n">target</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
  <span class="n">goos</span><span class="o">.</span><span class="n">opt</span><span class="o">.</span><span class="n">scipy_minimize</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Remember that actions are not actually executed until <code class="code docutils literal notranslate"><span class="pre">OptimizationPlan.run</span></code>
is invoked. The optimization plan maintains an action pointer that remembers
that last executed action, so you can execute an action, add more actions,
and then call <code class="code docutils literal notranslate"><span class="pre">run</span></code> again to execute only the newly added actions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">goos</span><span class="o">.</span><span class="n">OptimizationPlan</span><span class="p">()</span> <span class="k">as</span> <span class="n">plan</span><span class="p">:</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">goos</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

  <span class="c1"># Action to increment `x`.</span>
  <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>  <span class="c1"># Prints 1.</span>

  <span class="n">plan</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

  <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>  <span class="c1"># Prints 2.</span>

  <span class="n">x</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">plan</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

  <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>  <span class="c1"># Prints 3.</span>
</pre></div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="extending.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Extending SPINS</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="installation.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Solvers</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Vuckovic Lab
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Core Concepts</a><ul>
<li><a class="reference internal" href="#optimization-plan">Optimization Plan</a><ul>
<li><a class="reference internal" href="#optimization-plan-example">Optimization Plan Example</a></li>
<li><a class="reference internal" href="#executing-plans">Executing Plans</a></li>
<li><a class="reference internal" href="#retrieving-values">Retrieving Values</a></li>
<li><a class="reference internal" href="#logging-and-checkpoints">Logging and Checkpoints</a></li>
<li><a class="reference internal" href="#saving-and-loading-plans">Saving and Loading Plans</a></li>
<li><a class="reference internal" href="#debugging-plans">Debugging Plans</a></li>
</ul>
</li>
<li><a class="reference internal" href="#problem-graph">Problem Graph</a><ul>
<li><a class="reference internal" href="#variable-nodes">Variable Nodes</a></li>
<li><a class="reference internal" href="#math-nodes">Math Nodes</a></li>
<li><a class="reference internal" href="#shape-nodes">Shape Nodes</a></li>
<li><a class="reference internal" href="#simulation-nodes">Simulation Nodes</a></li>
<li><a class="reference internal" href="#flows">Flows</a><ul>
<li><a class="reference internal" href="#numericflow">NumericFlow</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#actions">Actions</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>